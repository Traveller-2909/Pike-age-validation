---
title: "Analysis pike age corroboration"
author: "TR"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**All code chunks except for figures used in the publication have "eval=FALSE" set in options, to avoid running the whole script every time a document is knitted. In order to run an indvidual code chunk, change options "eval=FALSE" to "eval=TRUE"**

```{r packages, include=FALSE}
library(here)
library(ggplot2)
library(tidyverse)
library(foreign)
library(lubridate)
library(car)
library(FSA)
library(flextable)
library(lme4)
library(ggpubr)
library(tidymodels)
library(nlstools)
library(bayesplot)
library(RColorBrewer)
library(loo)
library("rstan")
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(sjPlot)
```

## 3.1. Expected $\delta^{18}$O values in otolith aragonite
```{r moddeledd18Otest, echo=FALSE, include=FALSE, warning=FALSE, eval=FALSE}
rm(list = ls())

MonthsBodden <- read.delim("Data/Mean-TS_lagoons.txt", header = T, 
                           stringsAsFactors = F, sep = "\t", dec = ".")
Months_GB <- read.delim("Data/Mean-TS_GB.txt", header = T, 
                           stringsAsFactors = F, sep = "\t", dec = ".")
Months_NRB <- read.delim("Data/Mean-TS_NRB.txt", header = T, 
                           stringsAsFactors = F, sep = "\t", dec = ".")
Months_WRB <- read.delim("Data/Mean-TS_WRB.txt", header = T, 
                           stringsAsFactors = F, sep = "\t", dec = ".")
Aragonite_prediction <- read.delim("Data/Predicted_otolith_d18O.txt", header = T, 
                           stringsAsFactors = F, sep = "\t", dec = ".")

# Join data from all lagoon areas
MonthsBodden <- rbind(Months_GB, Months_NRB, Months_WRB)

# Test for significant differences between surface and bottom temperature
modeldepth <- lm(temperature~depth, data = MonthsBodden)
anova(modeldepth)

# Transform prediction table to long format
shorecompare <- Aragonite_prediction%>%
  pivot_longer(cols = c(temperature_shore, temperature_open), 
               names_to = "open_shore", values_to = "Temp")%>%
  transmute(month = month,
            date = date,
            site = case_when(open_shore %in% "temperature_shore" ~ "S",
                             open_shore %in% "temperature_open" ~"O"),
            temp = Temp)

# Test for differences in shore vs open lagoon temperature  
modelshore <- lm(temp~site, data = shorecompare)
anova(modelshore)

# Function to center values
center_scale <- function(x){
  scale(x, scale = F)
}

# Center Temperature & isotope measurements
Aragonite_prediction$Tcenter <- center_scale(Aragonite_prediction$temperature_open)
Aragonite_prediction$Dcenter <- center_scale(Aragonite_prediction$d18O_station)

# Mixed linear models for equation 1 (Patterson et al.)
# Base model
mR <- lmer(Prediction_Patterson_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction)

# Test significance of random effect month
rand(mR)

# Maximum likelihood estimation for significance testing
mR <- lmer(Prediction_Patterson_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction, REML = F)

# Model without Temperature
m1.1 <- lmer(Prediction_Patterson_WRB_VPDB~Dcenter+(1|month), data = Aragonite_prediction, REML = F)

# Model without isotope measurements
m1.2 <- lmer(Prediction_Patterson_WRB_VPDB~Tcenter+(1|month), data = Aragonite_prediction, REML = F)

anova(mR, m1.1) #Temperature significant
anova(mR, m1.2) #d18O significant

# Mixed linear models for equation 1 (Geffen et al.)
# Base model
mR2 <- lmer(Prediction_Geffen_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction)

# Test significance of random effect month
rand(mR2)

# Maximum likelihood estimation for significance testing
mR2 <- lmer(Prediction_Geffen_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction, REML = F)

# Model without Temperature
m2.1 <- lmer(Prediction_Geffen_WRB_VPDB~Dcenter+(1|month), data = Aragonite_prediction, REML = F)

# Model without isotope measurements
m2.2 <- lmer(Prediction_Geffen_WRB_VPDB~Tcenter+(1|month), data = Aragonite_prediction, REML = F)

anova(mR2, m2.1) #Temperature significant
anova(mR2, m2.2) #d18O significant

# Re-run final models with REML
Model.final.P <- lmer(Prediction_Patterson_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction)
Model.final.G <- lmer(Prediction_Geffen_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction)

# Assess summary
summary(Model.final.P)
summary(Model.final.G)

# Produce summary table
tab_model(Model.final.G, digits.re = 20)
```

```{r sensitivity & range, include=FALSE, eval=FALSE}
# Code for sensitivity & range calculations of d18O prediction equations
alpha = exp((18.56*1000*((20+273.15)^-1)-33.49)/1000)
(0.97001*(alpha*(1000-6.5)-1000)-29.99) - (0.97001*(alpha*(1000-6.5+sd(Aragonite_prediction$d18O_station))-1000)-29.99)

alpha = exp((15.99*1000*((20+273.15)^-1)-24.25)/1000)
(0.97001*(alpha*(1000-6.5)-1000)-29.99) - (0.97001*(alpha*(1000-6.5+sd(Aragonite_prediction$d18O_station))-1000)-29.99)

alpha = exp((18.56*1000*((20+273.15)^-1)-33.49)/1000)
alpha2 = exp((18.56*1000*((20+sd(Aragonite_prediction$temperature_open)+273.15)^-1)-33.49)/1000)
(0.97001*(alpha*(1000-6.5)-1000)-29.99) - (0.97001*(alpha2*(1000-6.5)-1000)-29.99)

alpha = exp((15.99*1000*((20+273.15)^-1)-24.25)/1000)
alpha2 = exp((15.99*1000*((20+sd(Aragonite_prediction$temperature_open)+273.15)^-1)-24.25)/1000)
(0.97001*(alpha*(1000-6.5)-1000)-29.99) - (0.97001*(alpha2*(1000-6.5)-1000)-29.99)

range(Aragonite_prediction$d18O_station)
range(Aragonite_prediction$temperature_open)

alpha = exp((18.56*1000*((15+273.15)^-1)-33.49)/1000)
alpha2 = exp((18.56*1000*((4+273.15)^-1)-33.49)/1000)
(0.97001*(alpha*(1000-5.3)-1000)-29.99) - (0.97001*(alpha2*(1000-5.3)-1000)-29.99)

(0.97001*(alpha*(1000-6.5)-1000)-29.99) - (0.97001*(alpha*(1000-6.5+(-4.2+6.5))-1000)-29.99)
```

```{r Figure 2 modelled d18O, echo=FALSE, dpi=600, message=F, warning=F}
rm(list = ls())

Aragonite_prediction <- read.delim("Data/Predicted_otolith_d18O.txt", header = T, 
                           stringsAsFactors = F, sep = "\t", dec = ".")

Aragonite_prediction$date <- lubridate::date(parse_date_time(Aragonite_prediction$date, orders = c("ymd")))

text_2020 <- text_grob("2020", size = 15)
text_2021 <- text_grob("2021", size = 15)
  
ggplot(Aragonite_prediction)+
  geom_line(aes(date, Prediction_Patterson_WRB_VPDB), color = "black", size = 1)+
  geom_point(aes(date, Prediction_Patterson_WRB_VPDB, shape = "Equation 1"), size = 3)+
  geom_line(aes(date, Prediction_Geffen_WRB_VPDB), color = "black", size = 1)+
  geom_point(aes(date, Prediction_Geffen_WRB_VPDB, shape = "Equation 2"), size = 3)+
  scale_y_continuous(limits = c(-6,-1.5), breaks = seq(-6, -1.5, .5))+
    coord_cartesian(clip = "off")+
  annotation_custom(text_2020, xmin = as.Date("2020-04-13"), xmax = as.Date("2020-04-13"), ymin = -8,ymax = -7)+  
  annotation_custom(text_2021, xmin = as.Date("2021-01-27"), xmax = as.Date("2021-01-27"), ymin = -8,ymax = -7)+
    scale_x_date(date_breaks = "1 month", 
                 date_labels = c("Mar", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb"))+
    scale_shape_manual(name = "", breaks = c("Equation 1", "Equation 2"), values = c(15, 17))+
  ylab(expression(atop(delta^18*"O"~"modelled aragonite", ("VPDB \u2030"))))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(),
        panel.grid.major.x = element_line(size = .5, colour = "grey", linetype = 2),
        axis.line = element_line(size = 1, colour = "black", linetype = 1), axis.title.y = element_text(size = 15),
        axis.ticks= element_line(size = 2), axis.text.y = element_text(size = 15, colour = "black"),
        axis.text.x = element_text(size = 15, colour = "black", angle = 90), axis.ticks.x = element_line(size = 2), 
        axis.title.x = element_text(size = 15, colour = "white"),
        legend.position = "bottom", legend.text = element_text(size = 15), legend.title = element_text(size = 15))

```

## 3.2. Obtaining a corroborated age estimation
```{r establish reference, include=FALSE}
#Script for precision, accuracy metrics and bias plots of corroborated ages

rm(list = ls())

#Read data
pikedata <- read.delim("Data/Pike_ages_all_with_TL_backcalulated.txt", header = T, stringsAsFactors = F)

#join
pikedata <- pikedata%>%
  transmute(id = id,
            Age_refAuto = age_ref,
            Age_refT = age_comb,
            Age_refC = age_combC)%>%
  distinct()

#Precision for combined images
AP_ref_compare <- agePrecision(~Age_refT + Age_refC, data = pikedata)
summary(AP_ref_compare, what = "precision")

#Bias for combined images, second argument is reference age
AB_ref_compare <- ageBias(Age_refT~Age_refC, data = pikedata, ref.lab = "comboT",
                            nref.lab = "comboC")
summary(AB_ref_compare)

#Precision for automated age
AP_auto_combo <- agePrecision(~Age_refAuto + Age_refT, data = pikedata)
AP_auto_comboC <- agePrecision(~Age_refAuto + Age_refC, data = pikedata)
summary(AP_auto_combo, what = "precision")
summary(AP_auto_comboC, what = "precision")

#Bias for automated age
ab_auto_combo <- ageBias(Age_refT ~ Age_refAuto, data = pikedata, ref.lab = "Auto", 
                         nref.lab = "comboT")

ab_auto_comboC <- ageBias(Age_refC ~ Age_refAuto, data = pikedata, ref.lab = "Auto", 
                    nref.lab = "comboC")

summary(ab_auto_combo)
summary(ab_auto_comboC)

save(AP_ref_compare, AB_ref_compare, AP_auto_comboC, AP_auto_combo, ab_auto_comboC, ab_auto_combo, file="Data/Refcompare.RData")

```

```{r Figure 4 Reference age comparison, echo=FALSE, dpi=600, message=F, warning=F}

rm(list = ls())

load("Data/Refcompare.RData")

Refcompare <- ggplot() +
  geom_hline(yintercept=0,linetype="dashed",color="darkgrey", size = 2) +
  geom_errorbar(data = ab_auto_combo$bias.diff, 
                aes(x=Age_refAuto,ymin=LCI,ymax=UCI,color=sig), width = 0)+
  geom_errorbar(data = ab_auto_comboC$bias.diff, 
                aes(x=Age_refAuto,ymin=LCI,ymax=UCI,color=sig), width = 0, color = "blue")+
  geom_point(data = ab_auto_combo$bias.diff, 
             aes(x=Age_refAuto, y=mean, color=sig, fill=sig),shape=21, size = 2)+
  geom_point(data = ab_auto_comboC$bias.diff, 
             aes(x=Age_refAuto, y=mean, color=sig, fill=sig),shape=18, size = 3, color = "blue")+
  geom_smooth(data=ab_auto_combo$data,aes(x=Age_refAuto,y=diff),size=.65, color = "blue")+
  geom_smooth(data=ab_auto_comboC$data,aes(x=Age_refAuto,y=diff),size=.65, color = "black")+
  scale_fill_manual(values=c("black","white"),guide="none") +
  scale_color_manual(values=c("black","red3"),guide="none") +
  scale_x_continuous(breaks=0:15) +
  scale_y_continuous(limits = c(-6,4), breaks=c(-6:4))+
  ylab("reader age - automated age")+
  xlab("corroborated age")+
  theme(panel.background = element_blank(), panel.grid.major = element_line(colour = "grey", linetype = "dotted"),
        panel.border = element_rect(colour = "black", fill = NA),
        axis.line = element_line(colour = "black", size = 1),
        axis.title = element_text(colour = "black", size = 15), 
        axis.text = element_text(colour = "black", size = 15))

Refcompare

```


## 3.3. Aging accuracy and bias of otoliths and scales
```{r agebias, include=FALSE}
# Script for age precision, accuracy and bias metrics & plots

rm(list = ls())

# load data
pikedata <- read.delim("Data/Pike_ages_all_with_TL_backcalulated.txt", header = T, stringsAsFactors = F)

#Explanation of columns:
# age_ref: Reference age (automated age counter)
# age_comb: Reader 1 corroboration age (otoliths + overplotted d18O)
# age_combC: Reader 3 corroboration age (otoliths + overplotted d18O)
# age_otoT: Reader 1 visual otolith age estimation
# age_otoK: Reader 2 visual otolith age estimation
# age_scaleT: Reader 1 visual scale age estimation
# age_scaleK: Reader 2 visual scale age estimation
# mrad.comb: otolith radius at last increment
# trad.comb: otolith total radius
# Length_LI: Length at last increment (backcalculation routine below)

pikedata <- pikedata%>%
  transmute(id = id,
            TL = TL,
            Age = age_ref,
            date = date)
# Age precision metrics
AP_scale1_ref <- agePrecision(~age_scaleT + age_ref, data = pikedata)
AP_scaleK_ref <- agePrecision(~age_scaleK + age_ref, data = pikedata)
AP_oto1_ref <- agePrecision(~age_otoT + age_ref, data = pikedata)
AP_otoK_ref <- agePrecision(~age_otoK + age_ref, data = pikedata)

summary(AP_scale1_ref, what = "precision")
summary(AP_scaleK_ref, what = "precision")
summary(AP_oto1_ref, what = "precision")
summary(AP_otoK_ref, what = "precision")

# Signed rank test for CVs
# Reader 1
Structure_vs_ref1 <- data.frame("ID" = pikedata$id, "CVOto" = AP_oto1_ref$detail$CV,
                    "CVScales1" = AP_scale1_ref$detail$CV)
Structure_vs_ref1 <- Structure_vs_ref1 %>% pivot_longer(!ID, names_to = "structure", values_to = "CV")
Structure_vs_ref1$structure <- sub("CVOto", "Oto", Structure_vs_ref1$structure)
Structure_vs_ref1$structure <- sub("CVScales1", "Scales", Structure_vs_ref1$structure)

CVTest1 <- wilcox.test(CV~structure, Structure_vs_ref1)

Structure_vs_refK <- data.frame("ID" = pikedata$id, "CVOto" = AP_otoK_ref$detail$CV,
                    "CVScales1" = AP_scaleK_ref$detail$CV)
Structure_vs_refK <- Structure_vs_refK %>% pivot_longer(!ID, names_to = "structure", values_to = "CV")
Structure_vs_refK$structure <- sub("CVOto", "Oto", Structure_vs_refK$structure)
Structure_vs_refK$structure <- sub("CVScales1", "Scales", Structure_vs_refK$structure)

CVTestK <- wilcox.test(CV~structure, Structure_vs_refK)

CVTest1
CVTestK

#Agebias
ab_scale1_ref <- ageBias(age_scaleT ~ age_ref, data = pikedata, 
                        ref.lab = "ref", nref.lab = "scales2")
ab_scaleK_ref <- ageBias(age_scaleK ~ age_ref, data = pikedata, 
                        ref.lab = "ref", nref.lab = "scalesK")
ab_oto1_ref <- ageBias(age_otoT ~ age_ref, data = pikedata, 
                        ref.lab = "ref", nref.lab = "otoT")
ab_otoK_ref <- ageBias(age_otoK ~ age_ref, data = pikedata, 
                        ref.lab = "ref", nref.lab = "otoK")

summary(ab_scale1_ref, flip.table = T)
summary(ab_scale1_ref, what = "symmetry")
summary(ab_scale1_ref, what = "bias")

summary(ab_scaleK_ref, flip.table = T)
summary(ab_scaleK_ref, what = "symmetry")
summary(ab_scaleK_ref, what = "bias")

summary(ab_oto1_ref, flip.table = T)
summary(ab_oto1_ref, what = "symmetry")
summary(ab_oto1_ref, what = "bias")

summary(ab_otoK_ref, flip.table = T)
summary(ab_otoK_ref, what = "symmetry")
summary(ab_otoK_ref, what = "bias")

# Save data
save(AP_oto1_ref, AP_otoK_ref, AP_scale1_ref, AP_scaleK_ref, ab_oto1_ref, ab_otoK_ref, ab_scale1_ref, ab_scaleK_ref, file="Data/AgeBias.RData")
```

```{r agebiastests, include=FALSE}
rm(list = ls())

# load data
load("Data/AgeBias.RData")
pikedata <- read.delim("Data/Pike_ages_all_with_TL_backcalulated.txt", header = T, stringsAsFactors = F)

# Age precision metrics

summary(ab_scale1_ref, flip.table = T)
summary(ab_scale1_ref, what = "symmetry")
summary(ab_scale1_ref, what = "bias")

summary(ab_scaleK_ref, flip.table = T)
summary(ab_scaleK_ref, what = "symmetry")
summary(ab_scaleK_ref, what = "bias")

summary(ab_oto1_ref, flip.table = T)
summary(ab_oto1_ref, what = "symmetry")
summary(ab_oto1_ref, what = "bias")

summary(ab_otoK_ref, flip.table = T)
summary(ab_otoK_ref, what = "symmetry")
summary(ab_otoK_ref, what = "bias")


summary(AP_scale1_ref, what = "precision")
summary(AP_scaleK_ref, what = "precision")
summary(AP_oto1_ref, what = "precision")
summary(AP_otoK_ref, what = "precision")

# Signed rank test for CVs
# Reader 1
Structure_vs_ref1 <- data.frame("ID" = pikedata$id, "CVOto" = AP_oto1_ref$detail$CV,
                    "CVScales1" = AP_scale1_ref$detail$CV)
Structure_vs_ref1 <- Structure_vs_ref1 %>% pivot_longer(!ID, names_to = "structure", values_to = "CV")
Structure_vs_ref1$structure <- sub("CVOto", "Oto", Structure_vs_ref1$structure)
Structure_vs_ref1$structure <- sub("CVScales1", "Scales", Structure_vs_ref1$structure)

CVTest1 <- wilcox.test(CV~structure, Structure_vs_ref1)

# Reader 2
Structure_vs_refK <- data.frame("ID" = pikedata$id, "CVOto" = AP_otoK_ref$detail$CV,
                    "CVScales1" = AP_scaleK_ref$detail$CV)
Structure_vs_refK <- Structure_vs_refK %>% pivot_longer(!ID, names_to = "structure", values_to = "CV")
Structure_vs_refK$structure <- sub("CVOto", "Oto", Structure_vs_refK$structure)
Structure_vs_refK$structure <- sub("CVScales1", "Scales", Structure_vs_refK$structure)

CVTestK <- wilcox.test(CV~structure, Structure_vs_refK)
```

```{r Table 1 age bias, echo=FALSE,message=FALSE,warning=FALSE,error=FALSE}

rm(list = ls())

load("Data/AgeBias.RData")

Overview_agebias <- cbind(rbind(summary(AP_scale1_ref, what = "precision"),
                                summary(AP_scaleK_ref, what = "precision"),
                                summary(AP_oto1_ref, what = "precision"),
                                summary(AP_otoK_ref, what = "precision")),
                          rbind(summary(AP_scale1_ref, what = "absolute",,3),
                                summary(AP_scaleK_ref, what = "absolute",,3), 
                                summary(AP_oto1_ref, what = "absolute",,3),
                                summary(AP_otoK_ref, what = "absolute",,3)))

Overview_agebias$sample <- c("Reader 1 scale age",  "Reader 2 scale age", 
                             "Reader1 otolith age", "Reader 2 otolith age")

Overview_agebias <- data.frame(Overview_agebias)
Overview_agebias$X1 <- Overview_agebias$X1 + Overview_agebias$X0
Overview_agebias$X2 <- Overview_agebias$X1 + Overview_agebias$X2

Overview_agebias[,c(3:11)] <- round(Overview_agebias[,c(3:11)], 1)
Overview_agebias$PercAgree <- paste(Overview_agebias$PercAgree, "%")
Overview_agebias$X1 <- paste(Overview_agebias$X1, "%")
Overview_agebias$X2 <- paste(Overview_agebias$X2, "%")

Overview <- flextable(Overview_agebias, col_keys = c("sample", "validn", "PercAgree","X1",
                                                     "X2", "ACV", "AAD", "APE"))%>%
  fontsize(part = "all", size = 10)%>%
  bold(part = "header")%>%
  set_header_labels(sample = "Structure", 
                    validn = "N", 
                    PercAgree = "% agreement",
                    X1 = "\u00B1 1 year", 
                    X2 = "\u00B1 2 years", 
                    ASD = "Average standard deviation",
                    ACV = "Average coefficient of variation [%]", 
                    AAD = "Average absolute deviation", 
                    APE = "Average percent error [%]")%>%
  set_caption("Summary of aging precision and accuracy metrics")%>%
  colformat_double(j = "ACV", suffix = "%")%>%
  colformat_double(j = "APE", suffix = "%")%>%
  colformat_double(j = "PercAgree", suffix = "%")%>%
  colformat_double(j = "X1", suffix = "%")%>%
  colformat_double(j = "X2", suffix = "%")%>%
  set_table_properties(layout = "autofit")

Overview
```


```{r Fraser Lee Backcalculation, include=FALSE, eval=FALSE}

# Script to convert length at capture to length at last increment using Fraser Lee equation

rm(list = ls())

# Read age data with radii
pikedata <- read.delim("Data/Pike_ages_all_with_TL.txt", header = T, 
                       stringsAsFactors = F)

# Visual examination
ggplot(pikedata, aes(log(trad_comb), log(TL))) + geom_point() + theme_minimal()
ggplot(pikedata, aes(trad_comb, TL)) + geom_point() + theme_minimal()

# Linear model of length at capture vs otolith radius at last increment
lmOto <- lm(TL~trad_comb, data = pikedata)
loglmOto <- lm(log(TL)~log(trad_comb), data = pikedata)
summary(lmOto)
summary(loglmOto)

# Extract coefficients for Backcalculation
a <- coefficients(loglmOto)[[1]]
b <- coefficients(loglmOto)[[2]]

# Add column with backcalculated lengths
pikedata <- pikedata %>%
  mutate(Length_LI = exp(log(TL)+b*(log(mrad_comb)-log(trad_comb))))
pikedata$Length_LI <- ifelse(pikedata$month <= 4, pikedata$TL, pikedata$Length_LI)

# Save table in data
write.table(pikedata, "Data/Pike_ages_all_with_TL_backcalulated.txt", sep = "\t", 
            dec = ".", row.names = F)
```

```{r Loocompare, include=FALSE, eval=FALSE}
rm(list = ls())

load("Data/LOO_compare.RData")

loos$mod1
print(loo_compare(loos), simplify = F)

looics = sapply(loos, function(x) x$estimates['looic', 'Estimate'])
delta_looic = looics - min(looics)
wi = exp(-0.5*delta_looic) / sum(exp(-0.5*delta_looic))
Loo <- as.data.frame(round(rbind(looic = looics, dlooic = delta_looic, weight = wi), 2))

Loo <- Loo%>%add_rownames()

Table <- Loo %>% flextable()%>%set_header_labels(rowname="", 
                                                 mod1="Model 1", 
                                                 mod2="Model 2",
                                                 mod3="Model 3")
save_as_docx(Table, path = "Tables/Loocompare.docx")