---
title: "Analysis pike age corroboration"
author: "TR"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**All code chunks except for figures used in the publication have "eval=FALSE" set in options, to avoid running the whole script every time a document is knitted. In order to run an indvidual code chunk, change options "eval=FALSE" to "eval=TRUE"**

```{r packages, include=FALSE}
library(here)
library(ggplot2)
library(tidyverse)
library(foreign)
library(lubridate)
library(car)
library(FSA)
library(flextable)
library(lme4)
library(ggpubr)
library(tidymodels)
library(nlstools)
library(bayesplot)
library(RColorBrewer)
library(loo)
library("rstan")
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(sjPlot)
```

## 3.1. Expected $\delta^{18}$O values in otolith aragonite
```{r moddeledd18Otest, echo=FALSE, include=FALSE, warning=FALSE, eval=FALSE}
rm(list = ls())

load("Data/Environmental_data.RData")

# Join data from all lagoon areas
MonthsBodden <- rbind(Months_GB, Months_NRB, Months_WRB)

# Test for significant differences between surface and bottom temperature
modeldepth <- lm(temperature~depth, data = MonthsBodden)
anova(modeldepth)

# Transform prediction table to long format
shorecompare <- Aragonite_prediction%>%
  pivot_longer(cols = c(temperature_shore, temperature_open), 
               names_to = "open_shore", values_to = "Temp")%>%
  transmute(month = month,
            date = date,
            site = case_when(open_shore %in% "temperature_shore" ~ "S",
                             open_shore %in% "temperature_open" ~"O"),
            temp = Temp)

# Test for differences in shore vs open lagoon temperature  
modelshore <- lm(temp~site, data = shorecompare)
anova(modelshore)

# Function to center values
center_scale <- function(x){
  scale(x, scale = F)
}

# Center Temperature & isotope measurements
Aragonite_prediction$Tcenter <- center_scale(Aragonite_prediction$temperature_open)
Aragonite_prediction$Dcenter <- center_scale(Aragonite_prediction$d18O_station)

# Mixed linear models for equation 1 (Patterson et al.)
# Base model
mR <- lmer(Prediction_Patterson_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction)

# Test significance of random effect month
rand(mR)

# Maximum likelihood estimation for significance testing
mR <- lmer(Prediction_Patterson_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction, REML = F)

# Model without Temperature
m1.1 <- lmer(Prediction_Patterson_WRB_VPDB~Dcenter+(1|month), data = Aragonite_prediction, REML = F)

# Model without isotope measurements
m1.2 <- lmer(Prediction_Patterson_WRB_VPDB~Tcenter+(1|month), data = Aragonite_prediction, REML = F)

anova(mR, m1.1) #Temperature significant
anova(mR, m1.2) #d18O significant

# Mixed linear models for equation 1 (Geffen et al.)
# Base model
mR2 <- lmer(Prediction_Geffen_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction)

# Test significance of random effect month
rand(mR2)

# Maximum likelihood estimation for significance testing
mR2 <- lmer(Prediction_Geffen_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction, REML = F)

# Model without Temperature
m2.1 <- lmer(Prediction_Geffen_WRB_VPDB~Dcenter+(1|month), data = Aragonite_prediction, REML = F)

# Model without isotope measurements
m2.2 <- lmer(Prediction_Geffen_WRB_VPDB~Tcenter+(1|month), data = Aragonite_prediction, REML = F)

anova(mR2, m2.1) #Temperature significant
anova(mR2, m2.2) #d18O significant

# Re-run final models with REML
Model.final.P <- lmer(Prediction_Patterson_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction)
Model.final.G <- lmer(Prediction_Geffen_WRB_VPDB~Dcenter+Tcenter+(1|month), data = Aragonite_prediction)

# Assess summary
summary(Model.final.P)
summary(Model.final.G)

# Produce summary table
tab_model(Model.final.G, digits.re = 20)
```

```{r Fraser Lee Backcalculation, include=FALSE, eval=FALSE}

# Script to convert length at capture to length at last increment using Fraser Lee equation

rm(list = ls())

# Read age data with radii
pikedata <- read.delim("Data/Pike_ages_all_with_TL.txt", header = T, 
                       stringsAsFactors = F)

# Visual examination
ggplot(pikedata, aes(log(trad_comb), log(TL))) + geom_point() + theme_minimal()
ggplot(pikedata, aes(trad_comb, TL)) + geom_point() + theme_minimal()

# Linear model of length at capture vs otolith radius at last increment
lmOto <- lm(TL~trad_comb, data = pikedata)
loglmOto <- lm(log(TL)~log(trad_comb), data = pikedata)
summary(lmOto)
summary(loglmOto)

# Extract coefficients for Backcalculation
a <- coefficients(loglmOto)[[1]]
b <- coefficients(loglmOto)[[2]]

# Add column with backcalculated lengths
pikedata <- pikedata %>%
  mutate(Length_LI = exp(log(TL)+b*(log(mrad_comb)-log(trad_comb))))
pikedata$Length_LI <- ifelse(pikedata$month <= 4, pikedata$TL, pikedata$Length_LI)

# Save table in data
write.table(pikedata, "Data/Pike_ages_all_with_TL_backcalulated.txt", sep = "\t", 
            dec = ".", row.names = F)
```

```{r Loocompare, include=FALSE, eval=FALSE}
rm(list = ls())

load("Data/LOO_compare.RData")

loos$mod1
print(loo_compare(loos), simplify = F)

looics = sapply(loos, function(x) x$estimates['looic', 'Estimate'])
delta_looic = looics - min(looics)
wi = exp(-0.5*delta_looic) / sum(exp(-0.5*delta_looic))
Loo <- as.data.frame(round(rbind(looic = looics, dlooic = delta_looic, weight = wi), 2))

Loo <- Loo%>%add_rownames()

Table <- Loo %>% flextable()%>%set_header_labels(rowname="", 
                                                 mod1="Model 1", 
                                                 mod2="Model 2",
                                                 mod3="Model 3")
save_as_docx(Table, path = "Tables/Loocompare.docx")